<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QDW91N3TER"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-QDW91N3TER');
</script>
<meta charset="UTF-8">
<meta name="robots" content="index, follow">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Color Online – Free Coloring Pages – Coco the Axolotl</title>
<meta name="description" content="Color Coco the Axolotl online! Free interactive coloring pages for kids with brush, fill bucket, and eraser tools. Download your colored creation as PNG.">
<link rel="canonical" href="https://cocotheaxolotl.org/coloring/">
<meta property="og:title" content="Color Online – Free Coloring Pages – Coco the Axolotl">
<meta property="og:description" content="Color Coco the Axolotl online! Free interactive coloring pages for kids.">
<meta property="og:url" content="https://cocotheaxolotl.org/coloring/">
<meta property="og:type" content="website">
<meta property="og:site_name" content="Coco the Axolotl">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Color Online – Free Coloring Pages">
<meta name="twitter:description" content="Color Coco the Axolotl online! Free interactive coloring pages for kids.">
<link rel="icon" type="image/x-icon" href="/favicon.ico?v=2">
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --pink:#ff69b4;
  --pink2:#f7c1cc;
  --bg:#fef6fb;
  --card:#ffffff;
  --text:#333;
  --muted:#666;
  --shadow:0 10px 26px rgba(0,0,0,.08);
  --border:2px solid rgba(255,105,180,.35);
  --radius:18px;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Baloo 2',cursive;background:#fef6fb;color:var(--text);text-align:center}

/* ===== Topbar ===== */
.topbar{
  display:flex;align-items:center;gap:12px;padding:14px 18px;
  border-bottom:1px solid #eee;background:#fff;position:sticky;top:0;z-index:5;
}
.brand{display:flex;align-items:center;gap:10px;font-weight:900;text-decoration:none;color:var(--text)}
.logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--pink),#8b5cf6);display:inline-block}
.nav{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.nav a{text-decoration:none;color:var(--muted);font-weight:700;padding:8px 10px;border-radius:12px}
.nav a:hover{background:#f7f7f7}

/* ===== Language ===== */
.lang-toggle{display:flex !important;gap:6px;align-items:center}
.lang-btn{padding:5px 12px;border-radius:10px;border:2px solid #001f3f;background:#fff;color:#001f3f;font-weight:800;cursor:pointer;font-size:.85em;font-family:'Baloo 2',cursive}
.lang-btn.active{background:#001f3f;color:#fff}
span[data-lang="fr"],span[data-lang="es"]{display:none}
[data-lang="fr"],[data-lang="es"]{display:none}
body.fr span[data-lang="fr"]{display:inline}
body.fr span[data-lang="en"],body.fr span[data-lang="es"]{display:none}
body.fr [data-lang="fr"]{display:block}
body.fr [data-lang="en"],body.fr [data-lang="es"]{display:none}
body.es span[data-lang="es"]{display:inline}
body.es span[data-lang="en"],body.es span[data-lang="fr"]{display:none}
body.es [data-lang="es"]{display:block}
body.es [data-lang="en"],body.es [data-lang="fr"]{display:none}

/* ===== Hero ===== */
header{background:#f7c1cc;padding:32px 20px 24px}
header h1{margin:0;font-size:2.2em;font-weight:800}
header p{margin:8px 0 0;font-size:1.05em;opacity:.85}

/* ===== Main ===== */
main{max-width:960px;margin:0 auto;padding:30px 20px 40px}

/* ===== Thumbnail grid ===== */
.thumb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin:24px 0}
.thumb-card{
  background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);
  border:var(--border);overflow:hidden;cursor:pointer;transition:transform .15s,box-shadow .15s;
}
.thumb-card:hover{transform:translateY(-3px);box-shadow:0 10px 26px rgba(0,0,0,.12)}
.thumb-card img{width:100%;height:auto;display:block;border-bottom:2px solid rgba(255,105,180,.1)}
.thumb-label{padding:12px;font-weight:800;font-size:.95em}

/* ===== Workspace ===== */
.workspace{margin-top:20px}

/* ===== Toolbar ===== */
.toolbar{
  display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:center;
  padding:12px 16px;background:var(--card);border-radius:var(--radius);
  border:var(--border);box-shadow:var(--shadow);margin-bottom:12px;
}
.tool-group{display:flex;gap:4px;align-items:center}
.tool-sep{width:1px;height:30px;background:#eee;margin:0 6px}
.tool-btn{
  width:44px;height:44px;border-radius:12px;border:2px solid #eee;background:#fff;
  cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;
  transition:border-color .2s,background .2s;color:var(--text);font-family:'Baloo 2',cursive;
}
.tool-btn:hover{border-color:#ffd1e3}
.tool-btn.active{border-color:var(--pink);background:rgba(255,105,180,.1)}
.tool-btn:disabled{opacity:.4;cursor:not-allowed}
.tool-btn svg{pointer-events:none}

/* ===== Palette ===== */
.palette{display:flex;flex-wrap:wrap;gap:5px;align-items:center}
.color-swatch{
  width:30px;height:30px;border-radius:50%;border:3px solid transparent;
  cursor:pointer;transition:transform .1s,border-color .1s;flex-shrink:0;
}
.color-swatch:hover{transform:scale(1.12)}
.color-swatch.active{border-color:#333;transform:scale(1.15)}
.color-swatch.white-swatch{box-shadow:inset 0 0 0 1px #ccc}

/* ===== Brush size ===== */
.size-group{display:flex;gap:6px;align-items:center}
.size-group input[type=range]{width:80px;accent-color:var(--pink)}
.size-label{font-size:12px;font-weight:800;min-width:28px;text-align:center}

/* ===== Canvas ===== */
.canvas-wrap{
  background:#f5f5f5;border-radius:var(--radius);padding:8px;
  border:var(--border);display:flex;justify-content:center;overflow:hidden;
}
#colorCanvas{
  max-width:100%;height:auto;border-radius:12px;display:block;
  cursor:crosshair;touch-action:none;background:#fff;
  box-shadow:0 8px 20px rgba(0,0,0,.06);
}

/* ===== Actions ===== */
.actions{
  display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;
  align-items:center;justify-content:center;
}
.btn{
  border:none;border-radius:14px;padding:12px 20px;font-weight:800;
  cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px;
  font-family:'Baloo 2',cursive;font-size:1em;transition:filter .2s;
}
.btn.primary{background:var(--pink);color:#fff}
.btn.primary:hover{filter:brightness(.95)}
.btn.ghost{background:#fff;color:var(--pink);border:2px solid var(--pink)}
.btn.ghost:hover{background:rgba(255,105,180,.06)}

/* ===== CTA section ===== */
.cta-section{margin-top:36px;padding:24px;background:#fff5f9;border-radius:22px}
.cta-section h2{margin:0 0 8px;font-size:1.3em;font-weight:800;color:var(--pink)}
.cta-section p{margin:0 0 14px;font-size:1em}
.cta{display:inline-block;margin:6px;padding:12px 28px;background:var(--pink);color:#fff;text-decoration:none;border-radius:32px;font-weight:700;font-family:'Baloo 2',cursive;transition:filter .2s}
.cta:hover{filter:brightness(.95)}

a.back{display:block;margin-top:30px;color:var(--pink);text-decoration:none;font-weight:800;font-size:1.05em}
a.back:hover{text-decoration:underline}
footer{padding:20px;font-size:.85em;opacity:.6}

/* ===== Responsive ===== */
@media(max-width:700px){
  .thumb-grid{grid-template-columns:repeat(2,1fr);gap:12px}
  header h1{font-size:1.7em}
  .toolbar{padding:10px;gap:6px}
  .tool-btn{width:38px;height:38px;font-size:16px}
  .color-swatch{width:26px;height:26px}
  .size-group input[type=range]{width:60px}
  .nav a{padding:6px 8px;font-size:.85em}
}
@media(max-width:480px){
  .thumb-grid{grid-template-columns:repeat(2,1fr)}
  .palette{justify-content:center}
  .toolbar{gap:5px}
  .color-swatch{width:24px;height:24px}
}
</style>
</head>

<body>

<!-- ===== Topbar ===== -->
<div class="topbar">
  <a href="/" class="brand">
    <span class="logo" aria-hidden="true"></span>
    <span>Coco</span>
  </a>
  <div class="nav">
    <a href="/"><span data-lang="en">Home</span><span data-lang="fr">Accueil</span><span data-lang="es">Inicio</span></a>
    <a href="/freebies/"><span data-lang="en">Freebies</span><span data-lang="fr">Gratuits</span><span data-lang="es">Gratis</span></a>
    <a href="/coloring-books/"><span data-lang="en">Books</span><span data-lang="fr">Livres</span><span data-lang="es">Libros</span></a>
    <div class="lang-toggle">
      <button class="lang-btn active" onclick="setLang('en')">EN</button>
      <button class="lang-btn" onclick="setLang('fr')">FR</button>
      <button class="lang-btn" onclick="setLang('es')">ES</button>
    </div>
  </div>
</div>

<!-- ===== Header ===== -->
<header>
  <h1>
    <span data-lang="en">Color Online</span>
    <span data-lang="fr">Coloriage en Ligne</span>
    <span data-lang="es">Colorea en L&iacute;nea</span>
  </h1>
  <p>
    <span data-lang="en">Pick a coloring page and start coloring!</span>
    <span data-lang="fr">Choisis un coloriage et commence &agrave; colorier !</span>
    <span data-lang="es">&iexcl;Elige un dibujo y empieza a colorear!</span>
  </p>
</header>

<main>

  <!-- ===== Thumbnail picker ===== -->
  <div id="pickerSection">
    <h2>
      <span data-lang="en">Choose a coloring page</span>
      <span data-lang="fr">Choisis un coloriage</span>
      <span data-lang="es">Elige un dibujo</span>
    </h2>
    <div class="thumb-grid" id="thumbGrid"></div>
  </div>

  <!-- ===== Workspace (hidden until image selected) ===== -->
  <div class="workspace" id="workspace" style="display:none">

    <!-- Toolbar -->
    <div class="toolbar" id="toolbar">
      <div class="tool-group">
        <button class="tool-btn active" data-tool="brush" title="Brush">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
        </button>
        <button class="tool-btn" data-tool="fill" title="Fill">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 22l1-1h3l9-9"/><path d="M3 21v-3l9-9"/><path d="M14 4l5 5"/><path d="M12 2l7 7-1.5 1.5-7-7z"/><path d="M19 15c.6.8 1.5 2.2 1.5 3.3A2.5 2.5 0 0118 20.8a2.5 2.5 0 01-2.5-2.5c0-1.1.9-2.5 1.5-3.3l1-1.3z"/></svg>
        </button>
        <button class="tool-btn" data-tool="eraser" title="Eraser">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 20H7L3 16l9-9 8 8-4 4z"/><path d="M6 11l8 8"/></svg>
        </button>
      </div>

      <div class="tool-sep"></div>

      <div class="palette" id="palette"></div>

      <div class="tool-sep"></div>

      <div class="size-group">
        <span class="size-label" id="sizeLabel">12</span>
        <input type="range" id="brushSize" min="2" max="50" value="12">
      </div>

      <div class="tool-sep"></div>

      <div class="tool-group">
        <button class="tool-btn" id="undoBtn" title="Undo" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 105.26-10.49L1 10"/></svg>
        </button>
        <button class="tool-btn" id="clearBtn" title="Clear">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>
        </button>
      </div>
    </div>

    <!-- Canvas -->
    <div class="canvas-wrap">
      <canvas id="colorCanvas"></canvas>
    </div>

    <!-- Action buttons -->
    <div class="actions">
      <button class="btn ghost" id="backBtn">
        <span data-lang="en">&larr; Back to gallery</span>
        <span data-lang="fr">&larr; Retour &agrave; la galerie</span>
        <span data-lang="es">&larr; Volver a la galer&iacute;a</span>
      </button>
      <button class="btn primary" id="downloadBtn">
        <span data-lang="en">Download PNG</span>
        <span data-lang="fr">T&eacute;l&eacute;charger PNG</span>
        <span data-lang="es">Descargar PNG</span>
      </button>
    </div>
  </div>

  <!-- ===== CTA section ===== -->
  <div class="cta-section">
    <h2>
      <span data-lang="en">Want more Coco?</span>
      <span data-lang="fr">Tu veux plus de Coco ?</span>
      <span data-lang="es">&iquest;Quieres m&aacute;s de Coco?</span>
    </h2>
    <p>
      <span data-lang="en">Get the full coloring book with 50+ pages on Amazon!</span>
      <span data-lang="fr">D&eacute;couvre le livre de coloriage complet avec 50+ pages sur Amazon !</span>
      <span data-lang="es">&iexcl;Consigue el libro de colorear completo con 50+ p&aacute;ginas en Amazon!</span>
    </p>
    <a class="cta amazon-book" href="https://www.amazon.com/dp/B0FN7FRVV6" target="_blank" rel="noopener" data-href-en="https://www.amazon.com/dp/B0FN7FRVV6" data-href-fr="https://www.amazon.fr/dp/B0FYMS84MR" data-href-es="https://www.amazon.com/dp/B0GCM24GF7">
      <span data-lang="en">Get the Coloring Book</span>
      <span data-lang="fr">Commander le Livre</span>
      <span data-lang="es">Comprar el Libro</span>
    </a>
    <a class="cta" href="/freebies/" style="background:transparent;color:var(--pink);border:2px solid var(--pink)">
      <span data-lang="en">Free Printable Pages</span>
      <span data-lang="fr">Coloriages Gratuits</span>
      <span data-lang="es">Dibujos Gratis</span>
    </a>
  </div>

  <a class="back" href="/">
    <span data-lang="en">&larr; Back to home</span>
    <span data-lang="fr">&larr; Retour &agrave; l'accueil</span>
    <span data-lang="es">&larr; Volver al inicio</span>
  </a>
</main>

<footer>&copy; 2026 Coco the Axolotl</footer>

<script>
(function(){
"use strict";

/* ===== Language toggle ===== */
function setLang(lang){
  document.body.className = lang==='fr'?'fr':lang==='es'?'es':'';
  document.querySelectorAll('.lang-btn').forEach(function(b){
    b.classList.toggle('active', b.textContent===lang.toUpperCase());
  });
  document.documentElement.lang = lang;
  document.querySelectorAll('.amazon-book').forEach(function(a){
    var h = a.getAttribute('data-href-'+lang);
    if(h) a.href = h;
  });
}
window.setLang = setLang;

/* ===== Coloring pages data ===== */
var PAGES = [
  {src:'/freebies/coco-and-boy.png', en:'Coco & Friend', fr:'Coco & son Ami', es:'Coco y su Amigo'},
  {src:'/freebies/coco-and-girl.png', en:'Coco & Friend', fr:'Coco & son Amie', es:'Coco y su Amiga'},
  {src:'/freebies/coco-christmas.png', en:"Coco's Christmas", fr:'Le No\u00ebl de Coco', es:'La Navidad de Coco'},
  {src:'/freebies/underwater-scene.png', en:'Underwater World', fr:'Monde Sous-Marin', es:'Mundo Submarino'},
  {src:'/freebies/axolotl-emotions.png', en:'Axolotl Emotions', fr:'\u00c9motions Axolotl', es:'Emociones Ajolote'},
];

/* ===== Color palette ===== */
var PALETTE = [
  '#FF0000','#FF6B35','#FFD700','#FFDAB9','#D2691E','#8B4513',
  '#FF69B4','#FF1493','#DA70D6','#9B59B6','#4A90D9','#00BFFF',
  '#2ECC71','#228B22','#F5F5DC','#A9A9A9','#000000','#FFFFFF'
];

/* ===== State ===== */
var state = {
  tool: 'brush',
  color: '#FF69B4',
  brushSize: 12,
  isDrawing: false,
  lastX: 0,
  lastY: 0,
  undoStack: [],
  maxUndo: 20,
  displayCanvas: null,
  displayCtx: null,
  paintCanvas: null,
  paintCtx: null,
  lineArtImage: null,
  hasPaint: false
};

var MAX_DIM = 1200;

/* ===== DOM refs ===== */
var thumbGrid = document.getElementById('thumbGrid');
var pickerSection = document.getElementById('pickerSection');
var workspace = document.getElementById('workspace');
var canvas = document.getElementById('colorCanvas');
var ctx = canvas.getContext('2d');
var paletteEl = document.getElementById('palette');
var brushSizeInput = document.getElementById('brushSize');
var sizeLabel = document.getElementById('sizeLabel');
var undoBtn = document.getElementById('undoBtn');
var clearBtn = document.getElementById('clearBtn');
var downloadBtn = document.getElementById('downloadBtn');
var backBtn = document.getElementById('backBtn');

state.displayCanvas = canvas;
state.displayCtx = ctx;

/* ===== Build thumbnail grid ===== */
PAGES.forEach(function(page){
  var card = document.createElement('div');
  card.className = 'thumb-card';
  card.innerHTML =
    '<img src="'+page.src+'" alt="'+page.en+' coloring page" loading="lazy">'+
    '<div class="thumb-label">'+
      '<span data-lang="en">'+page.en+'</span>'+
      '<span data-lang="fr">'+page.fr+'</span>'+
      '<span data-lang="es">'+page.es+'</span>'+
    '</div>';
  card.addEventListener('click', function(){ loadColoringPage(page); });
  thumbGrid.appendChild(card);
});

/* ===== Build palette ===== */
PALETTE.forEach(function(c){
  var swatch = document.createElement('div');
  swatch.className = 'color-swatch' + (c===state.color?' active':'') + (c==='#FFFFFF'?' white-swatch':'');
  swatch.style.background = c;
  swatch.dataset.color = c;
  swatch.addEventListener('click', function(){
    state.color = c;
    paletteEl.querySelectorAll('.color-swatch').forEach(function(s){
      s.classList.toggle('active', s.dataset.color===c);
    });
  });
  paletteEl.appendChild(swatch);
});

/* ===== Brush size ===== */
brushSizeInput.addEventListener('input', function(){
  state.brushSize = parseInt(this.value, 10);
  sizeLabel.textContent = state.brushSize;
});

/* ===== Tool selection ===== */
document.querySelectorAll('.tool-btn[data-tool]').forEach(function(btn){
  btn.addEventListener('click', function(){
    state.tool = btn.dataset.tool;
    document.querySelectorAll('.tool-btn[data-tool]').forEach(function(b){
      b.classList.toggle('active', b===btn);
    });
    canvas.style.cursor = state.tool==='fill'?'crosshair':'crosshair';
  });
});

/* ===== Load coloring page ===== */
function loadColoringPage(page){
  var img = new Image();
  img.onload = function(){
    var w = img.naturalWidth;
    var h = img.naturalHeight;
    if(w > MAX_DIM || h > MAX_DIM){
      var scale = MAX_DIM / Math.max(w, h);
      w = Math.round(w * scale);
      h = Math.round(h * scale);
    }

    canvas.width = w;
    canvas.height = h;

    state.paintCanvas = document.createElement('canvas');
    state.paintCanvas.width = w;
    state.paintCanvas.height = h;
    state.paintCtx = state.paintCanvas.getContext('2d');

    state.lineArtImage = img;
    state.undoStack = [];
    state.hasPaint = false;
    undoBtn.disabled = true;

    compositeRender();

    pickerSection.style.display = 'none';
    workspace.style.display = 'block';
    workspace.scrollIntoView({behavior:'smooth', block:'start'});
  };
  img.src = page.src;
}

/* ===== Composite render ===== */
function compositeRender(){
  var w = canvas.width;
  var h = canvas.height;

  ctx.globalCompositeOperation = 'source-over';
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, w, h);

  ctx.globalCompositeOperation = 'source-over';
  ctx.drawImage(state.paintCanvas, 0, 0);

  ctx.globalCompositeOperation = 'multiply';
  ctx.drawImage(state.lineArtImage, 0, 0, w, h);

  ctx.globalCompositeOperation = 'source-over';
}

/* ===== Coordinate mapping ===== */
function getCoords(e){
  var rect = canvas.getBoundingClientRect();
  var scaleX = canvas.width / rect.width;
  var scaleY = canvas.height / rect.height;
  var cx, cy;
  if(e.touches && e.touches.length > 0){
    cx = e.touches[0].clientX;
    cy = e.touches[0].clientY;
  } else {
    cx = e.clientX;
    cy = e.clientY;
  }
  return { x: (cx - rect.left) * scaleX, y: (cy - rect.top) * scaleY };
}

/* ===== Undo system ===== */
function pushUndo(){
  var data = state.paintCtx.getImageData(0, 0, state.paintCanvas.width, state.paintCanvas.height);
  state.undoStack.push(data);
  if(state.undoStack.length > state.maxUndo) state.undoStack.shift();
  undoBtn.disabled = false;
}

function undo(){
  if(state.undoStack.length === 0) return;
  var data = state.undoStack.pop();
  state.paintCtx.putImageData(data, 0, 0);
  compositeRender();
  undoBtn.disabled = state.undoStack.length === 0;
}

undoBtn.addEventListener('click', undo);

clearBtn.addEventListener('click', function(){
  if(!state.hasPaint) return;
  pushUndo();
  state.paintCtx.clearRect(0, 0, state.paintCanvas.width, state.paintCanvas.height);
  state.hasPaint = false;
  compositeRender();
});

/* ===== Drawing (brush & eraser) ===== */
function drawStroke(x1, y1, x2, y2){
  var pctx = state.paintCtx;
  pctx.save();
  if(state.tool === 'eraser'){
    pctx.globalCompositeOperation = 'destination-out';
    pctx.strokeStyle = 'rgba(0,0,0,1)';
  } else {
    pctx.globalCompositeOperation = 'source-over';
    pctx.strokeStyle = state.color;
  }
  pctx.lineWidth = state.brushSize;
  pctx.lineCap = 'round';
  pctx.lineJoin = 'round';
  pctx.beginPath();
  pctx.moveTo(x1, y1);
  pctx.lineTo(x2, y2);
  pctx.stroke();
  pctx.restore();
  state.hasPaint = true;
}

/* ===== Flood fill ===== */
function hexToRGB(hex){
  return {
    r: parseInt(hex.slice(1,3),16),
    g: parseInt(hex.slice(3,5),16),
    b: parseInt(hex.slice(5,7),16)
  };
}

function colorMatch(r1,g1,b1,r2,g2,b2,tol){
  return Math.abs(r1-r2)<=tol && Math.abs(g1-g2)<=tol && Math.abs(b1-b2)<=tol;
}

function floodFill(startX, startY, fillHex){
  compositeRender();
  var w = canvas.width;
  var h = canvas.height;
  var displayData = ctx.getImageData(0, 0, w, h);
  var px = displayData.data;

  startX = Math.max(0, Math.min(w-1, Math.round(startX)));
  startY = Math.max(0, Math.min(h-1, Math.round(startY)));

  var si = (startY * w + startX) * 4;
  var sR = px[si], sG = px[si+1], sB = px[si+2];

  var fill = hexToRGB(fillHex);

  if(colorMatch(sR,sG,sB,fill.r,fill.g,fill.b,10)) return;
  if(sR < 60 && sG < 60 && sB < 60) return;

  var TOL = 40;
  var visited = new Uint8Array(w * h);
  var queue = new Int32Array(w * h);
  var head = 0, tail = 0;
  var startIdx = startY * w + startX;
  queue[tail++] = startIdx;
  visited[startIdx] = 1;

  var paintData = state.paintCtx.getImageData(0, 0, w, h);
  var pd = paintData.data;

  while(head < tail){
    var idx = queue[head++];
    var px4 = idx * 4;

    if(colorMatch(px[px4], px[px4+1], px[px4+2], sR, sG, sB, TOL)){
      pd[px4]   = fill.r;
      pd[px4+1] = fill.g;
      pd[px4+2] = fill.b;
      pd[px4+3] = 255;

      var ix = idx % w;
      var iy = (idx / w) | 0;

      if(ix > 0   && !visited[idx-1])  { visited[idx-1] = 1;  queue[tail++] = idx-1; }
      if(ix < w-1 && !visited[idx+1])  { visited[idx+1] = 1;  queue[tail++] = idx+1; }
      if(iy > 0   && !visited[idx-w])  { visited[idx-w] = 1;  queue[tail++] = idx-w; }
      if(iy < h-1 && !visited[idx+w])  { visited[idx+w] = 1;  queue[tail++] = idx+w; }
    }
  }

  state.paintCtx.putImageData(paintData, 0, 0);
  state.hasPaint = true;
  compositeRender();
}

/* ===== Pointer events ===== */
var renderPending = false;
function requestRender(){
  if(renderPending) return;
  renderPending = true;
  requestAnimationFrame(function(){
    compositeRender();
    renderPending = false;
  });
}

function onPointerDown(e){
  e.preventDefault();
  if(!state.lineArtImage) return;
  var c = getCoords(e);

  if(state.tool === 'fill'){
    pushUndo();
    floodFill(c.x, c.y, state.color);
    return;
  }

  pushUndo();
  state.isDrawing = true;
  state.lastX = c.x;
  state.lastY = c.y;
  drawStroke(c.x, c.y, c.x, c.y);
  requestRender();
}

function onPointerMove(e){
  e.preventDefault();
  if(!state.isDrawing) return;
  var c = getCoords(e);
  drawStroke(state.lastX, state.lastY, c.x, c.y);
  state.lastX = c.x;
  state.lastY = c.y;
  requestRender();
}

function onPointerUp(e){
  if(e) e.preventDefault();
  state.isDrawing = false;
}

canvas.addEventListener('mousedown', onPointerDown);
canvas.addEventListener('mousemove', onPointerMove);
canvas.addEventListener('mouseup', onPointerUp);
canvas.addEventListener('mouseleave', onPointerUp);
canvas.addEventListener('touchstart', onPointerDown, {passive:false});
canvas.addEventListener('touchmove', onPointerMove, {passive:false});
canvas.addEventListener('touchend', onPointerUp);
canvas.addEventListener('touchcancel', onPointerUp);

/* ===== Download ===== */
downloadBtn.addEventListener('click', function(){
  compositeRender();
  var a = document.createElement('a');
  a.download = 'coco-coloring-' + Date.now() + '.png';
  a.href = canvas.toDataURL('image/png');
  a.click();
});

/* ===== Back to gallery ===== */
backBtn.addEventListener('click', function(){
  if(state.hasPaint){
    var lang = document.documentElement.lang || 'en';
    var msgs = {
      en: 'Your coloring will be lost. Go back?',
      fr: 'Ton coloriage sera perdu. Revenir ?',
      es: 'Tu dibujo se perder\u00e1. \u00bfVolver?'
    };
    if(!confirm(msgs[lang] || msgs.en)) return;
  }
  workspace.style.display = 'none';
  pickerSection.style.display = 'block';
  state.lineArtImage = null;
  state.undoStack = [];
  state.hasPaint = false;
  undoBtn.disabled = true;
  if(state.paintCtx) state.paintCtx.clearRect(0,0,state.paintCanvas.width,state.paintCanvas.height);
});

/* ===== Re-apply language on load ===== */
setLang('en');

})();
</script>
</body>
</html>
