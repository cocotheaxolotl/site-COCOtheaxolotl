<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" type="image/x-icon" href="/favicon.ico?v=2">
  <title>Coco ne dort pas ce soir ! &mdash; Lecture</title>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:'Baloo 2',cursive;
      background:#0d0d2b;
      color:#fff;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    /* ===== GATE SCREEN ===== */
    #gate{
      text-align:center;
      padding:40px 20px;
      max-width:420px;
    }
    #gate h1{ font-size:1.8em; margin-bottom:8px; }
    #gate p{ opacity:.7; margin-bottom:24px; line-height:1.5; }
    #gate .code-input{
      display:flex; gap:8px; justify-content:center;
      flex-wrap:wrap;
    }
    #gate input{
      padding:14px 20px; font-size:1.1em; font-family:'Baloo 2',cursive;
      border:2px solid rgba(255,255,255,.2); border-radius:12px;
      background:rgba(255,255,255,.08); color:#fff;
      text-align:center; width:240px;
      outline:none; transition:border-color .2s;
    }
    #gate input:focus{ border-color:rgba(255,255,255,.5); }
    #gate input::placeholder{ color:rgba(255,255,255,.3); }
    #gate .btn{
      padding:14px 32px; font-size:1.05em; font-weight:800;
      font-family:'Baloo 2',cursive;
      background:linear-gradient(135deg,#D6006E,#ff69b4);
      color:#fff; border:none; border-radius:32px;
      cursor:pointer; transition:filter .15s,transform .12s;
    }
    #gate .btn:hover{ filter:brightness(.9); transform:translateY(-1px); }
    #gate .error{
      color:#ff6b6b; font-size:.9em; margin-top:12px;
      display:none;
    }
    #gate .buy-link{
      display:block; margin-top:24px;
      color:rgba(255,255,255,.5); font-size:.85em;
    }
    #gate .buy-link a{ color:#ff69b4; }

    /* ===== READER ===== */
    #reader{ display:none; width:100vw; height:100vh; flex-direction:column; }
    #reader.active{ display:flex; }

    .toolbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:8px 16px; background:rgba(0,0,0,.4);
      flex-shrink:0;
    }
    .toolbar .title{ font-size:.95em; font-weight:600; opacity:.8; }
    .toolbar .page-info{ font-size:.85em; opacity:.6; }
    .toolbar button{
      background:rgba(255,255,255,.1); border:none; color:#fff;
      padding:8px 14px; border-radius:8px; cursor:pointer;
      font-family:'Baloo 2',cursive; font-size:.85em;
      transition:background .15s;
    }
    .toolbar button:hover{ background:rgba(255,255,255,.2); }

    #flipbook-container{
      flex:1; position:relative; overflow:hidden;
      max-width:1060px; width:100%; margin:0 auto;
    }

    .page{
      background:#fff; color:#333;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      text-align:center; padding:20px;
      font-size:1.15em; line-height:1.5;
      user-select:none; overflow:hidden;
    }
    .page.night{
      background:linear-gradient(135deg,#1a1a4e,#2d2d6e);
      color:#fff;
    }
    .page.light{
      background: url('/sleep-book/pages/text-bg.png') center/cover no-repeat;
      color:#333;
      padding:20px 26px;
      font-weight:600;
      font-size:1.3em;
    }
    .page .page-title{
      font-size:1.25em; font-weight:600; font-style:italic;
      color:#5c3d8e; text-align:center;
      margin:4px 0 8px;
    }
    .page.illust{
      background:#1a1a4e; color:#aaa;
      font-size:.85em; padding:0;
    }
    .page.illust img{
      width:100%; height:100%; object-fit:cover;
      display:block;
    }
    .page .page-wrap{
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      width:100%; height:100%;
    }
    .page .inner{ white-space:pre-line; max-width:100%; }
    .page .fact-box{
      margin-top:14px; padding:10px 14px;
      background:rgba(30,30,80,.75); border-radius:14px;
      font-size:.75em; color:rgba(255,255,255,.9);
      text-align:center;
    }
    .page .fact-box strong{ display:block; margin-bottom:4px; color:#fff; }

    /* Nav arrows */
    .nav-arrow{
      position:absolute; top:50%; transform:translateY(-50%);
      z-index:10; background:rgba(0,0,0,.3); border:none;
      color:#fff; font-size:1.8em; padding:12px 16px;
      border-radius:50%; cursor:pointer;
      transition:background .15s, opacity .15s;
      opacity:.6;
    }
    .nav-arrow:hover{ background:rgba(0,0,0,.5); opacity:1; }
    .nav-arrow.left{ left:12px; }
    .nav-arrow.right{ right:12px; }

    /* ===== AUDIO BAR ===== */
    .audio-bar{
      display:flex; align-items:center; gap:10px;
      padding:8px 16px; background:rgba(0,0,0,.5);
      flex-shrink:0;
    }
    .audio-btn{
      background:rgba(255,255,255,.12); border:none; color:#fff;
      width:38px; height:38px; border-radius:50%; cursor:pointer;
      font-size:1.1em; display:flex; align-items:center; justify-content:center;
      transition:background .15s;
      flex-shrink:0;
    }
    .audio-btn:hover{ background:rgba(255,255,255,.25); }
    .audio-btn.active{ background:rgba(247,201,72,.3); color:#f7c948; }
    .auto-indicator{
      font-size:.65em; font-weight:800; color:#f7c948;
      opacity:0; transition:opacity .2s; margin-left:-6px;
    }
    .auto-indicator.visible{ opacity:1; }
    .time-label{ font-size:.75em; opacity:.6; flex-shrink:0; min-width:32px; }
    .progress-wrap{
      flex:1; min-width:80px; height:6px;
      background:rgba(255,255,255,.15); border-radius:3px;
      cursor:pointer; position:relative;
    }
    .progress-fill{
      height:100%; background:#f7c948; border-radius:3px;
      width:0; transition:width .1s linear;
    }

    @media(max-width:600px){
      .nav-arrow{ display:none; }
      .toolbar .title{ font-size:.8em; }
      .audio-bar{ gap:6px; padding:6px 10px; }
      .audio-btn{ width:32px; height:32px; font-size:.95em; }
      .time-label{ font-size:.65em; }
      .page.light{ font-size:1em; padding:14px 18px; }
      .page .page-title{ font-size:1.15em; }
      .page .fact-box{ font-size:.65em; padding:8px 10px; }
    }
  </style>
</head>

<body>
  <!-- ===== GATE ===== -->
  <div id="gate">
    <h1>&#x1F319; Coco ne dort pas ce soir !</h1>
    <p>Entrez votre code d&rsquo;acc&egrave;s pour lire le livre.<br>
    Enter your access code to read the book.</p>
    <div class="code-input">
      <input type="text" id="codeInput" placeholder="COCO-XXXX-XXXX" autocomplete="off" spellcheck="false">
      <button class="btn" onclick="tryCode()">&#x1F513; Lire / Read</button>
    </div>
    <div class="error" id="errorMsg">
      Code invalide. / Invalid code.<br>
      <a href="/sleep-book/" style="color:#ff69b4;">Acheter le livre / Buy the book</a>
    </div>
    <div class="buy-link">
      Pas encore de code ? <a href="/sleep-book/">Acheter ici / Buy here</a>
    </div>
  </div>

  <!-- ===== READER ===== -->
  <div id="reader">
    <div class="toolbar">
      <a href="/sleep-book/" style="color:#fff;text-decoration:none;opacity:.7;">&larr; Retour</a>
      <span class="title">Coco ne dort pas ce soir !</span>
      <span class="page-info" id="pageInfo">1 / 31</span>
      <button onclick="toggleFullscreen()">&#x26F6; Plein &eacute;cran</button>
    </div>

    <div id="flipbook-container"></div>

    <button class="nav-arrow left" onclick="flipPrev()">&lsaquo;</button>
    <button class="nav-arrow right" onclick="flipNext()">&rsaquo;</button>

    <!-- Audio bar -->
    <div class="audio-bar">
      <button class="audio-btn" id="playBtn" title="Lecture / Pause">&#9654;&#65039;</button>
      <button class="audio-btn" id="autoBtn" title="Tourne-page automatique">&#128214;</button>
      <span class="auto-indicator" id="autoLabel">AUTO</span>
      <span class="time-label" id="timeNow">0:00</span>
      <div class="progress-wrap" id="progressWrap">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <span class="time-label" id="timeTotal">0:00</span>
    </div>
    <audio id="narrator" preload="auto"></audio>
    <audio id="bgMusic" src="/sleep-book/audio/lullaby.mp3" preload="auto" loop></audio>
    <div style="text-align:center;padding:6px;font-size:.7em;opacity:.4;">
      Par Dr. Nirvena &mdash; Illustrations de Loopinky
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/page-flip/dist/js/page-flip.browser.min.js"></script>
  <script>
    var VALID_CODE = 'COCO-DODO-2026';
    var pageFlip = null;

    /* ===== Book pages ===== */
    var IMG = '/sleep-book/Coco-ne-dort-pas-ce-soir-FR-sleep-book/';
    var bookPages = [];
    for(var i = 1; i <= 31; i++){
      bookPages.push({type:'illust', img: IMG+'Diapositive'+i+'.JPG'});
    }

    /* ===== CODE VALIDATION ===== */
    function tryCode(code){
      code = code || document.getElementById('codeInput').value.trim().toUpperCase();
      if(code === VALID_CODE){
        localStorage.setItem('sleep_book_access', 'true');
        showReader(true);
        return true;
      } else {
        document.getElementById('errorMsg').style.display = 'block';
        return false;
      }
    }

    function showReader(withAudio){
      document.getElementById('gate').style.display = 'none';
      document.getElementById('reader').classList.add('active');
      initFlipbook();
      if(withAudio){
        playTitle();
      }
    }

    /* ===== CHECK ACCESS ===== */
    (function(){
      var params = new URLSearchParams(window.location.search);
      var unlock = params.get('unlock');
      if(unlock){
        if(tryCode(unlock)){
          history.replaceState(null, '', window.location.pathname);
          return;
        }
      }
      if(localStorage.getItem('sleep_book_access') === 'true'){
        showReader(false);
        return;
      }
      document.getElementById('codeInput').addEventListener('keydown', function(e){
        if(e.key === 'Enter') tryCode();
      });
    })();

    /* ===== FLIPBOOK ===== */
    function initFlipbook(){
      var container = document.getElementById('flipbook-container');
      var maxW = Math.min(500, window.innerWidth - 40);
      var maxH = window.innerHeight - 60;
      var w, h;
      // Portrait 3:4 ratio
      if(maxH / maxW > 4/3){
        w = maxW; h = Math.round(w * 4 / 3);
      } else {
        h = maxH; w = Math.round(h * 3 / 4);
      }

      bookPages.forEach(function(p, i){
        var div = document.createElement('div');
        div.className = 'page illust';
        div.innerHTML = '<img src="'+p.img+'" alt="" loading="lazy">';
        if(i < bookPages.length - 1){
          div.style.backgroundImage = 'url('+bookPages[i+1].img+')';
          div.style.backgroundSize = 'cover';
          div.style.backgroundPosition = 'center';
        }
        container.appendChild(div);
      });

      try{
        pageFlip = new St.PageFlip(container, {
          width: w, height: h,
          size: 'stretch',
          minWidth: 280, maxWidth: 600,
          minHeight: 373, maxHeight: 800,
          showCover: true,
          mobileScrollSupport: false,
          useMouseEvents: true,
          flippingTime: 700,
          usePortrait: true,
          startZIndex: 0
        });
        pageFlip.loadFromHTML(container.querySelectorAll('.page'));
        pageFlip.on('flip', function(e){
          onPageFlip(e.data);
        });

      } catch(e){
        console.error('PageFlip init error:', e);
      }
    }

    function flipPrev(){ if(pageFlip) pageFlip.flipPrev(); }
    function flipNext(){ if(pageFlip) pageFlip.flipNext(); }

    function toggleFullscreen(){
      if(!document.fullscreenElement){
        document.documentElement.requestFullscreen().catch(function(){});
      } else {
        document.exitFullscreen();
      }
    }

    /* ===== AUDIO ===== */
    var audio = document.getElementById('narrator');
    var bgMusic = document.getElementById('bgMusic');
    bgMusic.volume = 0.15;
    var playBtn = document.getElementById('playBtn');
    var autoBtn = document.getElementById('autoBtn');
    var autoLabel = document.getElementById('autoLabel');
    var progressWrap = document.getElementById('progressWrap');
    var progressFill = document.getElementById('progressFill');
    var timeNow = document.getElementById('timeNow');
    var timeTotal = document.getElementById('timeTotal');

    var TOTAL_SPREADS = 15;
    var durations = [11.09, 24.89, 16.94, 32.69, 34.66, 30.00, 35.86, 31.44, 30.38, 33.86, 30.29, 32.54, 32.57, 32.88, 18.84];
    var totalDuration = 0;
    var cumulativeStarts = [];
    (function(){
      var cum = 0;
      for(var i = 0; i < durations.length; i++){
        cumulativeStarts.push(cum);
        cum += durations[i];
      }
      totalDuration = cum;
      timeTotal.textContent = fmtTime(totalDuration);
    })();

    var currentSpread = -1;
    var isPlaying = false;
    var autoTurn = true;
    var bgFadeTimer = null;
    var BG_VOLUME = 0.15;
    var playingSpecial = '';  // 'title', 'credits', or ''
    var TITLE_SRC = '/sleep-book/audio/spread_title.mp3';
    var CREDITS_SRC = '/sleep-book/audio/spread_credits.mp3';

    function fadeOutBgMusic(){
      clearInterval(bgFadeTimer);
      bgFadeTimer = setInterval(function(){
        if(bgMusic.volume > 0.01){
          bgMusic.volume = Math.max(0, bgMusic.volume - 0.005);
        } else {
          clearInterval(bgFadeTimer);
          bgMusic.pause();
          bgMusic.volume = BG_VOLUME;
        }
      }, 100);
    }

    function startBgMusic(){
      clearInterval(bgFadeTimer);
      bgMusic.volume = BG_VOLUME;
      bgMusic.play().catch(function(){});
    }

    function playTitle(){
      audio.src = TITLE_SRC;
      audio.load();
      audio.play();
      startBgMusic();
      isPlaying = true;
      playingSpecial = 'title';
      playBtn.innerHTML = '&#9646;&#9646;';
    }

    /* Page index (0-based) → spread number (-1 = no audio) */
    function pageToSpread(pg){
      if(pg <= 0) return -1;             // Cover (no narration)
      if(pg >= 29) return -1;            // Last pages (website + Cher Parent)
      return Math.floor((pg - 1) / 2) + 1;  // Pages 1-28 → spreads 1-14
    }

    function spreadAudioSrc(sp){
      return '/sleep-book/audio/spread_' + String(sp).padStart(2,'0') + '.mp3';
    }

    function fmtTime(s){
      var m = Math.floor(s / 60);
      var sec = Math.floor(s % 60);
      return m + ':' + String(sec).padStart(2,'0');
    }

    function loadSpreadAudio(sp){
      if(sp < 0 || sp >= TOTAL_SPREADS) return;
      currentSpread = sp;
      audio.src = spreadAudioSrc(sp);
      audio.load();
    }

    function playSpread(sp){
      if(sp < 0 || sp >= TOTAL_SPREADS) return;
      loadSpreadAudio(sp);
      audio.play();
      startBgMusic();
      isPlaying = true;
      playBtn.innerHTML = '&#9646;&#9646;';
    }

    function togglePlay(){
      if(audio.paused){
        if(!audio.src || audio.src === location.href || currentSpread < 0){
          var pg = pageFlip ? pageFlip.getCurrentPageIndex() : 0;
          if(pg === 0 && playingSpecial === ''){
            playTitle();
            return;
          }
          var sp = pageToSpread(pg);
          if(sp < 0) sp = 1;
          loadSpreadAudio(sp);
        }
        audio.play();
        startBgMusic();
        isPlaying = true;
        playBtn.innerHTML = '&#9646;&#9646;';
      } else {
        audio.pause();
        bgMusic.pause();
        isPlaying = false;
        playBtn.innerHTML = '&#9654;&#65039;';
      }
    }

    /* AUTO on by default */
    autoBtn.classList.add('active');
    autoLabel.classList.add('visible');

    function toggleAuto(){
      autoTurn = !autoTurn;
      autoBtn.classList.toggle('active', autoTurn);
      autoLabel.classList.toggle('visible', autoTurn);
    }

    function globalTime(){
      if(currentSpread < 0) return 0;
      return cumulativeStarts[currentSpread] + (audio.currentTime || 0);
    }

    playBtn.addEventListener('click', togglePlay);
    autoBtn.addEventListener('click', toggleAuto);

    audio.addEventListener('timeupdate', function(){
      var gt = globalTime();
      progressFill.style.width = (gt / totalDuration * 100) + '%';
      timeNow.textContent = fmtTime(gt);
    });

    /* Spread number → page index (0-based) */
    function spreadToPage(sp){
      if(sp === 0) return 0;           // spread_00 → cover
      return 1 + (sp - 1) * 2;  // spread 1→page 1, spread 2→page 3, etc.
    }

    audio.addEventListener('ended', function(){
      if(playingSpecial === 'title'){
        /* Title ended → flip to page 1 and start spread_01 */
        playingSpecial = '';
        if(autoTurn && pageFlip){
          pageFlip.flip(1);
          setTimeout(function(){
            if(currentSpread !== 1) playSpread(1);
          }, 1000);
        }
      } else if(playingSpecial === 'credits'){
        /* Credits ended → stop */
        isPlaying = false;
        playingSpecial = '';
        fadeOutBgMusic();
        playBtn.innerHTML = '&#9654;&#65039;';
      } else if(autoTurn && currentSpread >= 1 && currentSpread < TOTAL_SPREADS - 1){
        /* Story spreads 1-13 → advance to next */
        var nextSp = currentSpread + 1;
        var targetPage = spreadToPage(nextSp);
        if(pageFlip) pageFlip.flip(targetPage);
        setTimeout(function(){
          if(currentSpread !== nextSp) playSpread(nextSp);
        }, 1000);
      } else if(currentSpread === TOTAL_SPREADS - 1){
        /* Last story spread (14) ended → flip to end pages + play credits */
        if(pageFlip) pageFlip.flip(29);
        audio.src = CREDITS_SRC;
        audio.load();
        audio.play();
        playingSpecial = 'credits';
      } else {
        /* Fallback stop */
        isPlaying = false;
        playingSpecial = '';
        fadeOutBgMusic();
        playBtn.innerHTML = '&#9654;&#65039;';
      }
    });

    /* Click on progress bar to seek */
    progressWrap.addEventListener('click', function(e){
      var rect = progressWrap.getBoundingClientRect();
      var pct = (e.clientX - rect.left) / rect.width;
      var targetTime = pct * totalDuration;
      var targetSpread = 0;
      for(var i = TOTAL_SPREADS - 1; i >= 0; i--){
        if(targetTime >= cumulativeStarts[i]){
          targetSpread = i;
          break;
        }
      }
      var offset = targetTime - cumulativeStarts[targetSpread];
      if(targetSpread !== currentSpread){
        loadSpreadAudio(targetSpread);
      }
      audio.currentTime = offset;
      if(isPlaying) audio.play();
    });

    /* Sync audio when user flips pages */
    function onPageFlip(pgIndex){
      document.getElementById('pageInfo').textContent = (pgIndex + 1) + ' / ' + bookPages.length;
      var sp = pageToSpread(pgIndex);
      if(sp >= 0 && sp !== currentSpread){
        playSpread(sp);
      }
    }

    /* Spacebar to play/pause */
    document.addEventListener('keydown', function(e){
      if(e.key === ' ' && document.getElementById('reader').classList.contains('active')){
        e.preventDefault();
        togglePlay();
      }
    });
  </script>
</body>
</html>
