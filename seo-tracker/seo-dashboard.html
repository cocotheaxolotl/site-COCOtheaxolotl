<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coco SEO Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --pink:#ff69b4;--pink2:#f7c1cc;--pink3:#ffe0ef;
  --bg:#fef6fb;--card:#fff;--text:#333;
  --green:#27ae60;--red:#e74c3c;--orange:#f39c12;--gold:#f1c40f;--blue:#3498db;
  --shadow:0 10px 26px rgba(0,0,0,.08);
  --border:2px solid rgba(255,105,180,.35);
  --radius:18px;
}
body{font-family:'Baloo 2',cursive;background:var(--bg);color:var(--text);line-height:1.5}
a{color:var(--pink);text-decoration:none;font-weight:700}

/* Header */
.header{background:linear-gradient(135deg,var(--pink),#ff85c8);color:#fff;padding:24px 32px;display:flex;align-items:center;flex-wrap:wrap;gap:16px}
.header h1{font-size:1.8em;flex:1}
.header .meta{font-size:.85em;opacity:.9}
.header-actions{display:flex;gap:10px;flex-wrap:wrap}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 22px;border-radius:30px;border:none;font-family:inherit;font-size:.9em;font-weight:700;cursor:pointer;transition:.15s ease}
.btn-white{background:#fff;color:var(--pink)}
.btn-white:hover{background:var(--pink3)}
.btn-pink{background:var(--pink);color:#fff}
.btn-pink:hover{filter:brightness(.92)}
.btn-ghost{background:transparent;color:#fff;border:2px solid rgba(255,255,255,.6)}
.btn-ghost:hover{background:rgba(255,255,255,.15)}
.btn-sm{padding:6px 14px;font-size:.82em}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{filter:brightness(.9)}

/* Cards container */
.container{max-width:1400px;margin:0 auto;padding:24px}
.scores-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;margin-bottom:28px}
.score-card{background:var(--card);border:var(--border);border-radius:var(--radius);padding:18px;text-align:center;box-shadow:var(--shadow);transition:.2s}
.score-card:hover{transform:translateY(-2px);box-shadow:0 14px 32px rgba(0,0,0,.12)}
.score-card.target{border-color:var(--pink);border-width:3px;background:linear-gradient(135deg,#fff,var(--pink3))}
.score-card .domain{font-size:.78em;font-weight:700;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.score-card .score{font-size:2.2em;font-weight:800;color:var(--pink);margin:4px 0}
.score-card .change{font-size:.85em;font-weight:700}
.change.up{color:var(--green)}.change.down{color:var(--red)}.change.neutral{color:#999}

/* Toolbar */
.toolbar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:18px;padding:14px 18px;background:var(--card);border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
.toolbar select,.toolbar input[type="text"]{padding:8px 14px;border:2px solid var(--pink2);border-radius:12px;font-family:inherit;font-size:.88em;outline:none}
.toolbar select:focus,.toolbar input:focus{border-color:var(--pink)}
.toolbar label{font-weight:700;font-size:.85em}

/* Table */
.table-wrap{overflow-x:auto;margin-bottom:28px;background:var(--card);border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
table{width:100%;border-collapse:collapse;font-size:.88em}
thead{background:linear-gradient(135deg,var(--pink),#ff85c8);color:#fff;position:sticky;top:0;z-index:2}
th{padding:12px 14px;text-align:left;cursor:pointer;white-space:nowrap;font-weight:700;user-select:none}
th:hover{background:rgba(255,255,255,.15)}
th .sort-arrow{margin-left:4px;font-size:.7em}
td{padding:10px 14px;border-bottom:1px solid rgba(255,105,180,.1)}
tr:hover{background:rgba(255,105,180,.04)}
.kw-cell{font-weight:700;max-width:280px}
.kw-group{display:inline-block;padding:2px 8px;border-radius:8px;font-size:.7em;font-weight:700;margin-left:6px;vertical-align:middle}
.kw-group.coloring{background:#e8f8f5;color:#1abc9c}
.kw-group.bubble{background:#ebf5fb;color:#3498db}
.kw-group.axolotl{background:#fef9e7;color:#f39c12}
.kw-group.activities{background:#f4ecf7;color:#8e44ad}
.kw-group.games{background:#fdedec;color:#e74c3c}

/* Position badges */
.pos{display:inline-flex;align-items:center;justify-content:center;min-width:36px;padding:4px 10px;border-radius:10px;font-weight:800;font-size:.9em}
.pos.gold{background:#fef9e7;color:#d4ac0d}
.pos.green{background:#eafaf1;color:#27ae60}
.pos.yellow{background:#fef9e7;color:#f39c12}
.pos.orange{background:#fdf2e9;color:#e67e22}
.pos.red{background:#fdedec;color:#e74c3c}
.pos.none{background:#f8f9fa;color:#bbb;font-weight:600}
.pos.target{border:2px solid var(--pink)}
.pos-change{font-size:.72em;margin-left:4px;font-weight:800}
.pos-change.up{color:var(--green)}
.pos-change.down{color:var(--red)}

/* Editable cell */
td.editable{cursor:pointer;position:relative}
td.editable:hover{background:rgba(255,105,180,.08)}
td .manual-marker{position:absolute;top:2px;right:4px;width:6px;height:6px;background:var(--blue);border-radius:50%}
.inline-edit{width:50px;padding:4px 6px;border:2px solid var(--pink);border-radius:8px;font-family:inherit;font-size:.9em;text-align:center;outline:none}

/* Charts section */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:28px}
.chart-card{background:var(--card);border:var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
.chart-card h3{font-size:1.1em;margin-bottom:12px;color:var(--pink)}
.chart-card canvas{width:100%!important}

/* Manual entry panel */
.panel{background:var(--card);border:var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:28px}
.panel h3{font-size:1.1em;margin-bottom:14px;color:var(--pink);cursor:pointer;display:flex;align-items:center;gap:8px}
.panel h3 .toggle{transition:.2s;display:inline-block}
.panel h3 .toggle.collapsed{transform:rotate(-90deg)}
.panel-body{overflow:hidden;transition:max-height .3s ease}
.panel-body.collapsed{max-height:0!important}
.manual-form{display:flex;gap:10px;flex-wrap:wrap;align-items:end;margin-bottom:16px}
.manual-form .field{display:flex;flex-direction:column;gap:4px}
.manual-form .field label{font-size:.78em;font-weight:700;color:#888}
.manual-form .field input,.manual-form .field select{padding:8px 12px;border:2px solid var(--pink2);border-radius:10px;font-family:inherit;font-size:.85em;outline:none}
.manual-table{width:100%;font-size:.82em;border-collapse:collapse}
.manual-table th{background:var(--pink3);color:var(--text);padding:8px 12px;text-align:left;font-size:.85em}
.manual-table td{padding:6px 12px;border-bottom:1px solid var(--pink2)}

/* Empty state */
.empty-state{text-align:center;padding:80px 20px}
.empty-state h2{font-size:1.6em;color:var(--pink);margin-bottom:12px}
.empty-state p{color:#888;margin-bottom:24px;max-width:500px;margin-left:auto;margin-right:auto}

/* Responsive */
@media(max-width:820px){
  .header{padding:18px;flex-direction:column;text-align:center}
  .header h1{font-size:1.4em}
  .scores-grid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
  .charts-grid{grid-template-columns:1fr}
  .toolbar{flex-direction:column;align-items:stretch}
  .container{padding:14px}
}

/* File input hidden */
#fileInput{display:none}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <h1>Coco SEO Tracker</h1>
  <div class="meta" id="lastUpdated">Aucune donnee chargee</div>
  <div class="header-actions">
    <button class="btn btn-white" onclick="document.getElementById('fileInput').click()">Charger JSON</button>
    <button class="btn btn-ghost" onclick="exportCSV()" id="btnExport" style="display:none">Exporter CSV</button>
    <button class="btn btn-ghost" onclick="loadDemoData()">Demo</button>
    <input type="file" id="fileInput" accept=".json" onchange="handleFileLoad(event)">
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="container">

  <!-- Empty state (shown when no data loaded) -->
  <div class="empty-state" id="emptyState">
    <h2>Bienvenue !</h2>
    <p>Chargez votre fichier <strong>seo-results.json</strong> genere par le script Node.js, ou cliquez sur <strong>Demo</strong> pour voir un apercu avec des donnees fictives.</p>
    <button class="btn btn-pink" onclick="document.getElementById('fileInput').click()">Charger un fichier JSON</button>
  </div>

  <!-- Dashboard (hidden until data loaded) -->
  <div id="dashboard" style="display:none">

    <!-- Visibility Scores -->
    <div class="scores-grid" id="scoresGrid"></div>

    <!-- Toolbar -->
    <div class="toolbar">
      <label>Groupe :</label>
      <select id="filterGroup" onchange="renderTable()">
        <option value="all">Tous</option>
        <option value="coloring">Coloring</option>
        <option value="bubble">Bubble Letters</option>
        <option value="axolotl">Axolotl</option>
        <option value="activities">Activities</option>
        <option value="games">Games</option>
      </select>
      <input type="text" id="filterSearch" placeholder="Rechercher un mot-cle..." oninput="renderTable()">
      <label>Snapshot :</label>
      <select id="snapshotSelect" onchange="onSnapshotChange()"></select>
    </div>

    <!-- Ranking Table -->
    <div class="table-wrap">
      <table>
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-card">
        <h3>Historique des positions</h3>
        <canvas id="historyChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>Comparaison concurrents</h3>
        <div style="margin-bottom:10px">
          <select id="compareKeyword" onchange="renderCompareChart()" style="padding:6px 12px;border:2px solid var(--pink2);border-radius:10px;font-family:inherit;font-size:.85em"></select>
        </div>
        <canvas id="compareChart"></canvas>
      </div>
    </div>

    <!-- Manual Entry Panel -->
    <div class="panel">
      <h3 onclick="togglePanel()"><span class="toggle" id="panelToggle">&#9660;</span> Saisie manuelle</h3>
      <div class="panel-body" id="panelBody">
        <div class="manual-form">
          <div class="field">
            <label>Date</label>
            <input type="date" id="manualDate">
          </div>
          <div class="field">
            <label>Mot-cle</label>
            <input type="text" id="manualKeyword" list="keywordList" placeholder="ex: bubble letters">
            <datalist id="keywordList"></datalist>
          </div>
          <div class="field">
            <label>Domaine</label>
            <input type="text" id="manualDomain" placeholder="ex: cocotheaxolotl.org">
          </div>
          <div class="field">
            <label>Position</label>
            <input type="number" id="manualPosition" min="1" max="100" placeholder="1-100">
          </div>
          <button class="btn btn-pink btn-sm" onclick="addManualEntry()">Ajouter</button>
        </div>
        <table class="manual-table">
          <thead><tr><th>Date</th><th>Mot-cle</th><th>Domaine</th><th>Position</th><th></th></tr></thead>
          <tbody id="manualTableBody"></tbody>
        </table>
        <div style="margin-top:12px">
          <button class="btn btn-danger btn-sm" onclick="clearManualData()">Effacer les donnees manuelles</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
let seoData = null;          // Loaded JSON data
let manualEntries = [];      // localStorage manual entries
let currentSnapshotIdx = -1; // Currently displayed snapshot index
let sortCol = null;
let sortDir = 1;
let historyChart = null;
let compareChart = null;

// Keyword group mapping (from config)
const KEYWORD_GROUPS = {};

// ============================================================
// FILE LOADING
// ============================================================
function handleFileLoad(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const data = JSON.parse(ev.target.result);
      loadSeoData(data);
      localStorage.setItem('seo_data_cache', ev.target.result);
    } catch (err) {
      alert('Erreur de lecture du fichier JSON : ' + err.message);
    }
  };
  reader.readAsText(file);
}

function loadSeoData(data) {
  seoData = data;
  if (!seoData.snapshots || seoData.snapshots.length === 0) {
    alert('Aucun snapshot trouve dans les donnees.');
    return;
  }

  // Build keyword group mapping from first snapshot
  const firstResults = seoData.snapshots[0].results;
  // We'll infer groups from the config keywords list if available
  buildKeywordGroups();

  // Show dashboard
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('btnExport').style.display = '';

  // Update last updated
  const lastDate = new Date(seoData.metadata.lastUpdated || seoData.snapshots[seoData.snapshots.length - 1].date);
  document.getElementById('lastUpdated').textContent = 'Derniere MAJ : ' + lastDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });

  // Populate snapshot selector
  const sel = document.getElementById('snapshotSelect');
  sel.innerHTML = '';
  seoData.snapshots.forEach((s, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = new Date(s.date).toLocaleDateString('fr-FR');
    sel.appendChild(opt);
  });
  sel.value = seoData.snapshots.length - 1;
  currentSnapshotIdx = seoData.snapshots.length - 1;

  // Populate keyword datalist for manual entry
  populateKeywordList();

  // Set default manual domain
  document.getElementById('manualDomain').value = seoData.metadata.targetDomain || '';
  document.getElementById('manualDate').valueAsDate = new Date();

  // Render everything
  renderScores();
  renderTable();
  renderHistoryChart();
  renderCompareChart();
  renderManualTable();
}

function buildKeywordGroups() {
  // Infer groups from keyword content
  const groupRules = [
    { group: 'coloring', patterns: ['coloring', 'printable coloring', 'coloring sheets'] },
    { group: 'bubble', patterns: ['bubble'] },
    { group: 'axolotl', patterns: ['axolotl facts', 'what is an axolotl', 'why are axolotls', 'axolotl fun', 'axolotl for kids'] },
    { group: 'activities', patterns: ['calm', 'quiet', 'screen-free', 'benefits of coloring'] },
    { group: 'games', patterns: ['games', 'tips', 'supplies', 'coloring book', 'activities printable'] },
  ];
  // Gather all keywords from all snapshots
  const allKws = new Set();
  seoData.snapshots.forEach(s => Object.keys(s.results).forEach(k => allKws.add(k)));
  allKws.forEach(kw => {
    const kwLower = kw.toLowerCase();
    for (const rule of groupRules) {
      if (rule.patterns.some(p => kwLower.includes(p))) {
        KEYWORD_GROUPS[kw] = rule.group;
        return;
      }
    }
    KEYWORD_GROUPS[kw] = 'games'; // default
  });
}

function populateKeywordList() {
  const dl = document.getElementById('keywordList');
  dl.innerHTML = '';
  const allKws = new Set();
  seoData.snapshots.forEach(s => Object.keys(s.results).forEach(k => allKws.add(k)));
  allKws.forEach(kw => {
    const opt = document.createElement('option');
    opt.value = kw;
    dl.appendChild(opt);
  });
}

// ============================================================
// VISIBILITY SCORES
// ============================================================
function calcVisibility(snapshot, domain, maxResults) {
  const keywords = Object.keys(snapshot.results);
  let score = 0;
  keywords.forEach(kw => {
    const pos = snapshot.results[kw]?.[domain];
    if (pos !== null && pos !== undefined) {
      score += (maxResults + 1 - pos) / maxResults;
    }
  });
  // Normalize to 0-100
  return keywords.length > 0 ? (score / keywords.length) * 100 : 0;
}

function renderScores() {
  const grid = document.getElementById('scoresGrid');
  grid.innerHTML = '';
  const snap = seoData.snapshots[currentSnapshotIdx];
  const prevSnap = currentSnapshotIdx > 0 ? seoData.snapshots[currentSnapshotIdx - 1] : null;
  const maxR = 30;
  const target = seoData.metadata.targetDomain;
  const allDomains = [target, ...(seoData.metadata.competitors || [])];

  allDomains.forEach(domain => {
    const vis = calcVisibility(snap, domain, maxR);
    const prevVis = prevSnap ? calcVisibility(prevSnap, domain, maxR) : null;
    const diff = prevVis !== null ? vis - prevVis : 0;

    const card = document.createElement('div');
    card.className = 'score-card' + (domain === target ? ' target' : '');
    const changeClass = diff > 0.5 ? 'up' : diff < -0.5 ? 'down' : 'neutral';
    const changeIcon = diff > 0.5 ? '&#9650;' : diff < -0.5 ? '&#9660;' : '&#8212;';
    const changeText = diff !== 0 ? (diff > 0 ? '+' : '') + diff.toFixed(1) : '';

    card.innerHTML = `
      <div class="domain" title="${domain}">${domain.replace('.com','').replace('.org','').replace('.ws','')}</div>
      <div class="score">${vis.toFixed(1)}</div>
      <div class="change ${changeClass}">${changeIcon} ${changeText}</div>
    `;
    grid.appendChild(card);
  });
}

// ============================================================
// RANKING TABLE
// ============================================================
function getAllDomains() {
  if (!seoData) return [];
  return [seoData.metadata.targetDomain, ...(seoData.metadata.competitors || [])];
}

function getPositionClass(pos) {
  if (pos === null || pos === undefined) return 'none';
  if (pos <= 3) return 'gold';
  if (pos <= 10) return 'green';
  if (pos <= 20) return 'yellow';
  if (pos <= 30) return 'orange';
  return 'red';
}

function renderTable() {
  const snap = seoData.snapshots[currentSnapshotIdx];
  const prevSnap = currentSnapshotIdx > 0 ? seoData.snapshots[currentSnapshotIdx - 1] : null;
  const allDomains = getAllDomains();
  const target = seoData.metadata.targetDomain;

  // Filters
  const groupFilter = document.getElementById('filterGroup').value;
  const searchFilter = document.getElementById('filterSearch').value.toLowerCase();

  // Get keywords
  let keywords = Object.keys(snap.results);
  if (groupFilter !== 'all') {
    keywords = keywords.filter(kw => KEYWORD_GROUPS[kw] === groupFilter);
  }
  if (searchFilter) {
    keywords = keywords.filter(kw => kw.toLowerCase().includes(searchFilter));
  }

  // Sort
  if (sortCol !== null) {
    keywords.sort((a, b) => {
      let va, vb;
      if (sortCol === 'keyword') {
        va = a; vb = b;
        return sortDir * va.localeCompare(vb);
      }
      va = snap.results[a]?.[sortCol] ?? 999;
      vb = snap.results[b]?.[sortCol] ?? 999;
      return sortDir * (va - vb);
    });
  }

  // Merge manual entries for current snapshot date
  const manualForDate = getManualForDate(snap.date);

  // Header
  const thead = document.getElementById('tableHead');
  let headHtml = '<tr>';
  headHtml += `<th onclick="setSort('keyword')">Mot-cle ${sortArrow('keyword')}</th>`;
  allDomains.forEach(d => {
    const short = d.replace('.com','').replace('.org','').replace('.ws','');
    const isTarget = d === target ? ' style="color:#ffe0ef"' : '';
    headHtml += `<th onclick="setSort('${d}');"${isTarget}>${short} ${sortArrow(d)}</th>`;
  });
  headHtml += '</tr>';
  thead.innerHTML = headHtml;

  // Body
  const tbody = document.getElementById('tableBody');
  let bodyHtml = '';
  keywords.forEach(kw => {
    bodyHtml += '<tr>';
    const group = KEYWORD_GROUPS[kw] || 'games';
    bodyHtml += `<td class="kw-cell">${kw}<span class="kw-group ${group}">${group}</span></td>`;

    allDomains.forEach(d => {
      let pos = snap.results[kw]?.[d];
      let isManual = false;

      // Check manual override
      const manualKey = `${kw}|||${d}`;
      if (manualForDate[manualKey] !== undefined) {
        pos = manualForDate[manualKey];
        isManual = true;
      }

      // Change vs previous
      const prevPos = prevSnap?.results[kw]?.[d] ?? null;
      let changeHtml = '';
      if (prevPos !== null && pos !== null && pos !== undefined) {
        const diff = prevPos - pos; // positive = improved
        if (diff > 0) changeHtml = `<span class="pos-change up">&#9650;${diff}</span>`;
        else if (diff < 0) changeHtml = `<span class="pos-change down">&#9660;${Math.abs(diff)}</span>`;
      }

      const posClass = getPositionClass(pos);
      const targetClass = d === target ? ' target' : '';
      const posText = (pos === null || pos === undefined) ? '-' : pos;
      const manualDot = isManual ? '<span class="manual-marker"></span>' : '';

      bodyHtml += `<td class="editable" onclick="startEdit(this,'${kw}','${d}')" title="Cliquer pour modifier">`;
      bodyHtml += `<span class="pos ${posClass}${targetClass}">${posText}</span>${changeHtml}${manualDot}`;
      bodyHtml += '</td>';
    });

    bodyHtml += '</tr>';
  });
  tbody.innerHTML = bodyHtml;
}

function sortArrow(col) {
  if (sortCol !== col) return '<span class="sort-arrow">&#8597;</span>';
  return sortDir === 1 ? '<span class="sort-arrow">&#9650;</span>' : '<span class="sort-arrow">&#9660;</span>';
}

function setSort(col) {
  if (sortCol === col) sortDir *= -1;
  else { sortCol = col; sortDir = 1; }
  renderTable();
}

function onSnapshotChange() {
  currentSnapshotIdx = parseInt(document.getElementById('snapshotSelect').value);
  renderScores();
  renderTable();
}

// ============================================================
// INLINE EDITING
// ============================================================
function startEdit(td, keyword, domain) {
  if (td.querySelector('.inline-edit')) return;
  const currentPos = td.querySelector('.pos')?.textContent;
  const val = currentPos === '-' ? '' : currentPos;
  td.innerHTML = `<input class="inline-edit" type="number" min="1" max="100" value="${val}" onblur="finishEdit(this,'${keyword}','${domain}')" onkeydown="if(event.key==='Enter')this.blur();" autofocus>`;
  td.querySelector('input').focus();
}

function finishEdit(input, keyword, domain) {
  const val = input.value.trim();
  if (val && !isNaN(val)) {
    const pos = parseInt(val);
    const snap = seoData.snapshots[currentSnapshotIdx];
    const entry = {
      date: snap.date.split('T')[0],
      keyword,
      domain,
      position: pos,
      timestamp: new Date().toISOString()
    };
    manualEntries.push(entry);
    saveManualEntries();
  }
  renderTable();
  renderManualTable();
}

// ============================================================
// CHARTS
// ============================================================
const CHART_COLORS = [
  '#ff69b4','#3498db','#2ecc71','#e74c3c','#f39c12',
  '#9b59b6','#1abc9c','#e67e22','#34495e','#95a5a6'
];

function renderHistoryChart() {
  if (historyChart) historyChart.destroy();
  const target = seoData.metadata.targetDomain;
  const labels = seoData.snapshots.map(s => new Date(s.date).toLocaleDateString('fr-FR'));

  // Get all keywords, pick top 5 by best position in latest snapshot
  const latestSnap = seoData.snapshots[seoData.snapshots.length - 1];
  const kwPositions = Object.entries(latestSnap.results)
    .map(([kw, positions]) => ({ kw, pos: positions[target] ?? 999 }))
    .sort((a, b) => a.pos - b.pos)
    .slice(0, 5);

  const datasets = kwPositions.map((item, idx) => ({
    label: item.kw,
    data: seoData.snapshots.map(s => {
      const p = s.results[item.kw]?.[target];
      return p ?? null;
    }),
    borderColor: CHART_COLORS[idx % CHART_COLORS.length],
    backgroundColor: CHART_COLORS[idx % CHART_COLORS.length] + '22',
    tension: 0.3,
    pointRadius: 4,
    pointHoverRadius: 6,
    spanGaps: true,
  }));

  const ctx = document.getElementById('historyChart').getContext('2d');
  historyChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom', labels: { font: { family: "'Baloo 2'" } } }
      },
      scales: {
        y: {
          reverse: true,
          min: 1,
          max: 30,
          title: { display: true, text: 'Position', font: { family: "'Baloo 2'", weight: 'bold' } },
          ticks: { font: { family: "'Baloo 2'" } }
        },
        x: { ticks: { font: { family: "'Baloo 2'" } } }
      }
    }
  });
}

function renderCompareChart() {
  if (compareChart) compareChart.destroy();
  const sel = document.getElementById('compareKeyword');
  const snap = seoData.snapshots[currentSnapshotIdx];

  // Populate keyword selector if empty
  if (sel.options.length === 0) {
    Object.keys(snap.results).forEach(kw => {
      const opt = document.createElement('option');
      opt.value = kw;
      opt.textContent = kw;
      sel.appendChild(opt);
    });
  }

  const kw = sel.value;
  if (!kw || !snap.results[kw]) return;

  const allDomains = getAllDomains();
  const positions = allDomains.map(d => snap.results[kw][d] ?? null);
  const colors = allDomains.map((d, i) =>
    d === seoData.metadata.targetDomain ? '#ff69b4' : CHART_COLORS[(i + 1) % CHART_COLORS.length]
  );

  const ctx = document.getElementById('compareChart').getContext('2d');
  compareChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: allDomains.map(d => d.replace('.com','').replace('.org','').replace('.ws','')),
      datasets: [{
        label: 'Position',
        data: positions.map(p => p ?? 0),
        backgroundColor: colors.map(c => c + '88'),
        borderColor: colors,
        borderWidth: 2,
        borderRadius: 8,
      }]
    },
    options: {
      responsive: true,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => ctx.raw === 0 ? 'Non classe' : `Position: ${ctx.raw}`
          }
        }
      },
      scales: {
        x: {
          reverse: true,
          min: 0,
          max: 30,
          title: { display: true, text: 'Position (1 = meilleur)', font: { family: "'Baloo 2'" } },
          ticks: { font: { family: "'Baloo 2'" } }
        },
        y: { ticks: { font: { family: "'Baloo 2'", weight: 'bold' } } }
      }
    }
  });
}

// ============================================================
// MANUAL ENTRIES (localStorage)
// ============================================================
function loadManualEntries() {
  try {
    manualEntries = JSON.parse(localStorage.getItem('seo_manual_entries') || '[]');
  } catch (_) { manualEntries = []; }
}

function saveManualEntries() {
  localStorage.setItem('seo_manual_entries', JSON.stringify(manualEntries));
}

function getManualForDate(dateStr) {
  const dateKey = dateStr.split('T')[0];
  const map = {};
  manualEntries.forEach(e => {
    if (e.date === dateKey) {
      map[`${e.keyword}|||${e.domain}`] = e.position;
    }
  });
  return map;
}

function addManualEntry() {
  const date = document.getElementById('manualDate').value;
  const keyword = document.getElementById('manualKeyword').value.trim();
  const domain = document.getElementById('manualDomain').value.trim();
  const position = parseInt(document.getElementById('manualPosition').value);

  if (!date || !keyword || !domain || isNaN(position)) {
    alert('Veuillez remplir tous les champs.');
    return;
  }

  manualEntries.push({ date, keyword, domain, position, timestamp: new Date().toISOString() });
  saveManualEntries();

  document.getElementById('manualKeyword').value = '';
  document.getElementById('manualPosition').value = '';

  renderManualTable();
  renderTable();
}

function removeManualEntry(idx) {
  manualEntries.splice(idx, 1);
  saveManualEntries();
  renderManualTable();
  renderTable();
}

function clearManualData() {
  if (!confirm('Supprimer toutes les donnees manuelles ?')) return;
  manualEntries = [];
  saveManualEntries();
  renderManualTable();
  renderTable();
}

function renderManualTable() {
  const tbody = document.getElementById('manualTableBody');
  if (manualEntries.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#bbb;padding:16px">Aucune entree manuelle</td></tr>';
    return;
  }
  tbody.innerHTML = manualEntries.map((e, i) =>
    `<tr><td>${e.date}</td><td>${e.keyword}</td><td>${e.domain}</td><td>${e.position}</td><td><button class="btn btn-danger btn-sm" onclick="removeManualEntry(${i})">&times;</button></td></tr>`
  ).join('');
}

function togglePanel() {
  const body = document.getElementById('panelBody');
  const toggle = document.getElementById('panelToggle');
  body.classList.toggle('collapsed');
  toggle.classList.toggle('collapsed');
}

// ============================================================
// CSV EXPORT
// ============================================================
function exportCSV() {
  if (!seoData) return;
  const snap = seoData.snapshots[currentSnapshotIdx];
  const allDomains = getAllDomains();
  const date = new Date(snap.date).toLocaleDateString('fr-FR');

  let csv = 'Date,Mot-cle,' + allDomains.join(',') + '\n';
  Object.keys(snap.results).forEach(kw => {
    const row = [date, `"${kw}"`];
    allDomains.forEach(d => {
      const pos = snap.results[kw][d];
      row.push(pos === null || pos === undefined ? '-' : pos);
    });
    csv += row.join(',') + '\n';
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `seo-tracker-${date.replace(/\//g, '-')}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ============================================================
// DEMO DATA
// ============================================================
function loadDemoData() {
  const target = 'cocotheaxolotl.org';
  const competitors = ['supercoloring.com','crayola.com','education.com','coloring.ws','thecolor.com','natgeokids.com','dltk-kids.com','cooltext.com'];
  const keywords = [
    'axolotl coloring pages','axolotl coloring pages for kids','free printable coloring pages',
    'coloring pages for kids','coloring activities for kids','free coloring pages animals',
    'printable coloring sheets','cute animal coloring pages','bubble letters',
    'bubble letters generator','bubble letter alphabet','how to draw bubble letters',
    'bubble letters name generator','printable bubble letters','what is an axolotl',
    'axolotl facts for kids','why are axolotls endangered','axolotl fun facts',
    'axolotl for kids','calm activities for kids','quiet time activities',
    'screen-free activities for kids','benefits of coloring for children',
    'printable games for kids','coloring tips for kids','best coloring supplies for kids',
    'coloring books for kids ages 3-8','kids activities printable','axolotl coloring book'
  ];

  function randPos(domain, kw) {
    // Simulate realistic positions
    const hash = (domain + kw).split('').reduce((a, c) => a + c.charCodeAt(0), 0);
    const base = hash % 40;
    if (base > 28) return null; // not ranked
    return Math.max(1, Math.min(30, base + 1));
  }

  const snapshots = [];
  // Generate 4 weekly snapshots
  for (let w = 3; w >= 0; w--) {
    const date = new Date();
    date.setDate(date.getDate() - w * 7);
    const results = {};
    keywords.forEach(kw => {
      results[kw] = {};
      [target, ...competitors].forEach(d => {
        const base = randPos(d, kw);
        if (base === null) { results[kw][d] = null; return; }
        // Add some variation over time
        const variation = Math.floor(Math.random() * 5) - 2;
        results[kw][d] = Math.max(1, Math.min(30, base + variation * (3 - w)));
      });
    });
    snapshots.push({ date: date.toISOString(), results });
  }

  const demoData = {
    metadata: { targetDomain: target, competitors, lastUpdated: new Date().toISOString() },
    snapshots
  };

  loadSeoData(demoData);
}

// ============================================================
// INIT
// ============================================================
loadManualEntries();

// Try loading cached data from localStorage
const cached = localStorage.getItem('seo_data_cache');
if (cached) {
  try {
    loadSeoData(JSON.parse(cached));
  } catch (_) {}
}
</script>
</body>
</html>
